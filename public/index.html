<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bounties</title>
  <link rel="stylesheet" href="Bountiestyl.css" />
</head>

<body>
  <nav>
    <a href="/" class="active">ğŸ’° Submit Bounties</a>
    <a href="/admin">ğŸ“ Mappool Suggestions</a>
    <a href="/community">ğŸ“Œ Vote & Browse</a>
  </nav>

  <div class="container">
    <div class="header">
      <h1>Bounties Submission</h1>
      <p>Submit a Beatmap for The Next Challenge</p>
    </div>

    <div class="form-section">
      <div class="form-grid">
        <div class="form-group">
          <label>Beatmap URL</label>
          <input id="url" placeholder="https://osu.ppy.sh/beatmapsets/...#osu/..." />
        </div>

        <div class="form-group">
          <label>Challenge</label>
          <input id="challenge" placeholder="Pass, FC, #1 Algeria, Best Acc" />
        </div>

        <div class="form-group">
          <label>Mods</label>
          <input id="mods" placeholder="e.g. NM, HD, HR, DT" />
        </div>

        <div class="form-group">
          <label>Map Difficulty</label>
          <input id="difficulty" placeholder="e.g. Insane, Expert" />
        </div>

        <div class="form-group">
          <label>Song Title</label>
          <input id="title" readonly />
        </div>
      </div>

      <div class="stats-grid">
        <div class="form-group">
          <label>Stars</label>
          <input id="stars" readonly />
        </div>

        <div class="form-group">
          <label>CS</label>
          <input id="cs" readonly />
        </div>

        <div class="form-group">
          <label>AR</label>
          <input id="ar" readonly />
        </div>

        <div class="form-group">
          <label>OD</label>
          <input id="od" readonly />
        </div>

        <div class="form-group">
          <label>BPM</label>
          <input id="bpm" readonly />
        </div>

        <div class="form-group">
          <label>Length</label>
          <input id="length" readonly />
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary" id="addBountyBtn">â• Submit Bounty</button>
      </div>
    </div>

    <div class="output-section">
      <h2 class="section-title">ğŸ—‚ï¸ Current Beatmaps (<span id="count">0</span>)</h2>
      <div id="output"></div>
    </div>
  </div>

  <div id="user-registration-modal">
    <div class="modal-content">
      <h2>ğŸ‘‹ Welcome!</h2>
      <p>Please enter a display name to vote and submit maps.</p>
      <form id="registration-form">
        <input
          type="text"
          id="username-input"
          placeholder="Username"
          required
          minlength="3"
          maxlength="20"
          autocomplete="off"
        />
        <br />
        <button type="submit">Start Browsing</button>
      </form>
    </div>
  </div>

  <script>
    let bounties = [];
    let currentAudio = null;
    let editingBountyId = null;

    function extractId(url) {
      const match = String(url || "").match(/osu\/(\d+)/);
      return match ? match[1] : null;
    }

    function extractSetId(url) {
      const match = String(url || "").match(/beatmapsets\/(\d+)/);
      return match ? match[1] : null;
    }

    function beatmapIdFromOsuUrl(url) {
      if (!url) return null;
      const s = String(url);
      const m = s.match(/#osu\/(\d+)/) || s.match(/osu\/(\d+)/);
      return m ? m[1] : null;
    }
    
    function safeStr(x) {
      return (x === null || x === undefined) ? "" : String(x);
    }

    function fetchInfo() {
      const url = document.getElementById("url").value;
      const id = extractId(url);
      const setId = extractSetId(url);
      if (!id) return;

      const inputs = ['title', 'stars', 'cs', 'ar', 'od', 'bpm', 'length'];
      inputs.forEach(k => {
        const el = document.getElementById(k);
        el.value = 'Loading...';
        el.classList.add('loading');
      });

      fetch("/api/beatmap/" + id)
        .then(r => r.json())
        .then(d => {
          document.getElementById("title").value = d.title || "";
          document.getElementById("stars").value = safeStr(d.stars ?? "").replace("â˜…", "").replace("â­", "");
          document.getElementById("cs").value = d.cs ?? "N/A";
          document.getElementById("ar").value = d.ar ?? "N/A";
          document.getElementById("od").value = d.od ?? "N/A";
          document.getElementById("bpm").value = d.bpm ?? "N/A";
          document.getElementById("length").value = d.length ?? "N/A";

          const fallbackPreview = setId ? `https://b.ppy.sh/preview/${setId}.mp3` : "/";
          const fallbackCover = setId ? `https://assets.ppy.sh/beatmaps/${setId}/covers/cover.jpg` : "";

          window.currentBeatmapData = {
            preview_url: d.preview_url || fallbackPreview,
            cover_url: d.cover_url || fallbackCover,
            length: d.length ?? "N/A"
          };

          inputs.forEach(k => document.getElementById(k).classList.remove('loading'));
        })
        .catch(err => {
          console.error("Beatmap fetch failed:", err);
          inputs.forEach(k => {
            const el = document.getElementById(k);
            el.value = '';
            el.classList.remove('loading');
          });
          window.currentBeatmapData = null;
          alert("Couldn't fetch beatmap info. Please check the URL.");
        });
    }

    async function loadBounties() {
      try {
        const res = await fetch('/api/beatmaps/list');
        const data = await res.json();
        bounties = (Array.isArray(data) ? data : []).filter(x => x.type === "bounty");
        renderOutput();
      } catch (err) {
        console.error("Failed to load bounties:", err);
      }
    }

 function renderOutput() {
      const out = document.getElementById("output");
      const count = document.getElementById("count");
      if (!out || !count) return;

      const currentUserId = localStorage.getItem("act_user_id");

      count.textContent = bounties.length;
      out.innerHTML = "";

      bounties.forEach((m) => {
        const isOwner = currentUserId && (String(m.submitted_by) === String(currentUserId));
        const bmId = beatmapIdFromOsuUrl(m.url);

        out.innerHTML += `
          <div class="beatmap-card">
            ${m.cover_url ? `<img src="${m.cover_url}" alt="Cover" class="cover-image" data-cover="1">` : ''}

            <div class="beatmap-header">
              <div>
                <span class="slot-badge">${m.slot || ''}</span>
              </div>
              <div style="font-size: 0.9rem; color: #94a3b8;">${m.mod || ''}</div>
            </div>

            <a href="${m.url}" target="_blank" rel="noopener noreferrer"
               class="beatmap-title" style="text-decoration: none; color: #f1f5f9;">
              ${m.title || 'Unknown title'}
            </a>

            <div class="beatmap-stats">
              <div class="stat-item"><span class="stat-label">Stars</span><span class="stat-value">${m.stars ?? 'N/A'}</span></div>
              <div class="stat-item"><span class="stat-label">CS</span><span class="stat-value">${m.cs ?? 'N/A'}</span></div>
              <div class="stat-item"><span class="stat-label">AR</span><span class="stat-value">${m.ar ?? 'N/A'}</span></div>
              <div class="stat-item"><span class="stat-label">OD</span><span class="stat-value">${m.od ?? 'N/A'}</span></div>
              <div class="stat-item"><span class="stat-label">BPM</span><span class="stat-value">${m.bpm ?? 'N/A'}</span></div>
              <div class="stat-item"><span class="stat-label">Length</span><span class="stat-value">${m.length ?? 'N/A'}</span></div>
            </div>

            <div style="margin-top: 0.5rem;">
              ${m.skill ? `<span class="skill-tag">ğŸ¯ ${m.skill}</span>` : ''}
              <div style="margin-top: 0.25rem; font-size: 0.85rem; color: #60a5fa;">
                ğŸ‘¤ Submitted by: ${m.submitted_by_name || 'Unknown'}
              </div>
            </div>

            <div class="beatmap-actions" style="margin-top: 0.5rem;">
              ${isOwner ? `
                <button class="btn-small btn-edit" data-action="edit" data-id="${m.id}">âœï¸ Edit</button>
                <button class="btn-small btn-delete" data-action="delete" data-id="${m.id}">ğŸ—‘ï¸ Delete</button>
              ` : ''}

              ${m.preview_url && m.preview_url !== "/" ? `
                <button class="btn-small btn-preview" data-action="preview" data-preview="${m.preview_url}">ğŸ”Š Preview</button>
              ` : ''}

              ${bmId ? `
                <button class="btn-small btn-replay" data-action="replay" data-b="${bmId}">ğŸ¬ Replay (JoSu!)</button>
              ` : ''}
            </div>
          </div>
        `;
      });

  out.querySelectorAll("button[data-action]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const action = btn.dataset.action;

      if (action === "edit") {
        editBounty(btn.dataset.id);
      } else if (action === "delete") {
        deleteBounty(btn.dataset.id);
      } else if (action === "preview") {
        playPreview(btn.dataset.preview);
      } else if (action === "replay") {
        openReplayPreview(btn.dataset.b);
      }
    });
  });
}

  function openReplayPreview(beatmapId) {
  const url = `https://preview.tryz.id.vn/?b=${encodeURIComponent(beatmapId)}&m=`;
  window.open(url, "_blank", "noopener,noreferrer");
}

    function playPreview(previewUrl) {
      try {
        if (currentAudio) currentAudio.pause();
        currentAudio = new Audio(previewUrl);
        currentAudio.volume = 0.5;
        currentAudio.play().catch((e) => {
          console.error("Preview error:", e);
          alert("Could not play preview (browser may block it).");
        });

        setTimeout(() => {
          if (currentAudio) {
            currentAudio.pause();
            currentAudio = null;
          }
        }, 30000);
      } catch (e) {
        console.error(e);
        alert("Preview failed.");
      }
    }


    function editBounty(id) {
      const b = bounties.find(x => String(x.id) === String(id));
      if (!b) return;

      editingBountyId = b.id;

      document.getElementById("url").value = b.url || "";
      document.getElementById("challenge").value = b.skill || "";
      document.getElementById("mods").value = b.mod || "";
      document.getElementById("difficulty").value = b.slot || "";

      document.getElementById("title").value = b.title || "";
      document.getElementById("stars").value = b.stars ?? "";
      document.getElementById("cs").value = b.cs ?? "";
      document.getElementById("ar").value = b.ar ?? "";
      document.getElementById("od").value = b.od ?? "";
      document.getElementById("bpm").value = b.bpm ?? "";
      document.getElementById("length").value = b.length ?? "";

      window.currentBeatmapData = {
        preview_url: b.preview_url || "/",
        cover_url: b.cover_url || ""
      };

      const btn = document.getElementById('addBountyBtn');
      btn.innerText = "ğŸ’¾ Save Changes";

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function deleteBounty(id) {
      const userId = localStorage.getItem("act_user_id");
      if (!userId) return alert("Please register/login first.");

      const ok = confirm("Are you sure you want to delete this beatmap?");
      if (!ok) return;

      try {
        const res = await fetch(`/api/beatmaps/${id}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
            "x-user-id": userId
          }
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          alert("Delete failed: " + (data.error || "Not allowed"));
          return;
        }

        if (String(editingBountyId) === String(id)) {
          editingBountyId = null;
          document.getElementById('addBountyBtn').innerText = "â• Submit Bounty";
        }

        loadBounties();
      } catch (err) {
        console.error(err);
        alert("Delete failed: network error");
      }
    }


    async function addBounty() {
      const userId = localStorage.getItem('act_user_id');
      const username = localStorage.getItem('act_username');

      if (!userId) {
        alert("Please register a name first!");
        document.getElementById('user-registration-modal').style.display = 'flex';
        return;
      }

      const entry = {
        url: document.getElementById("url").value,
        skill: document.getElementById("challenge").value,
        mod: document.getElementById("mods").value,
        slot: document.getElementById("difficulty").value,
        title: document.getElementById("title").value,
        stars: document.getElementById("stars").value,
        cs: document.getElementById("cs").value,
        ar: document.getElementById("ar").value,
        od: document.getElementById("od").value,
        bpm: document.getElementById("bpm").value,
        length: document.getElementById("length").value,
        preview_url: window.currentBeatmapData?.preview_url || "/",
        cover_url: window.currentBeatmapData?.cover_url || "",
        type: "bounty",
        submitted_by: userId,
        submitted_by_name: username || "Unknown"
      };

      if (!entry.url || !entry.skill) {
        alert("Please fill in the Beatmap URL and Challenge.");
        return;
      }

      const btn = document.getElementById('addBountyBtn');
      btn.disabled = true;

      const isEdit = editingBountyId !== null;
      btn.innerText = isEdit ? "Saving..." : "Submitting...";

      try {
        const endpoint = isEdit ? `/api/beatmaps/${editingBountyId}` : `/api/beatmaps/submit`;
        const method = isEdit ? "PUT" : "POST";

        const response = await fetch(endpoint, {
          method,
          headers: {
            'Content-Type': 'application/json',
            "x-user-id": userId
          },
          body: JSON.stringify(entry)
        });

        const result = await response.json();

        if (response.ok) {
          if (!isEdit) {
            sendToDiscord(entry);
            alert('Bounty Submitted Successfully!');
          } else {
            alert('Changes Saved!');
          }

          editingBountyId = null;
          btn.innerText = "â• Submit Bounty";

          loadBounties();

          ['url','challenge','mods','difficulty','title','stars','cs','ar','od','bpm','length'].forEach(id => {
            document.getElementById(id).value = '';
          });
          window.currentBeatmapData = null;
        } else {
          alert('Error: ' + (result.error || "Unknown error"));
        }
      } catch (err) {
        console.error(err);
        alert('Failed to connect to server');
      } finally {
        btn.disabled = false;
        btn.innerText = (editingBountyId === null) ? "â• Submit Bounty" : "ğŸ’¾ Save Changes";
      }
    }

    function sendToDiscord(entry) {
      fetch("/api/send-discord", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(entry)
      }).catch(err => console.error("Discord error:", err));
    }


    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('url').addEventListener('blur', fetchInfo);
      document.getElementById('addBountyBtn').addEventListener('click', addBounty);

      loadBounties();

      const userId = localStorage.getItem('act_user_id');
      const modal = document.getElementById('user-registration-modal');

      if (!userId) {
        modal.style.display = 'flex';
      }

      document.getElementById('registration-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('username-input').value.trim();
        if (username.length < 3) return alert('Name too short!');

        try {
          const response = await fetch('/api/users/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ display_name: username })
          });

          const data = await response.json();

          if (response.ok) {
            localStorage.setItem('act_user_id', data.id);
            localStorage.setItem('act_username', data.display_name);
            localStorage.setItem('act_is_admin', data.is_admin);

            modal.style.display = 'none';
            alert(`Welcome, ${data.display_name}!`);

            loadBounties();
          } else {
            alert(data.error || 'Registration failed');
          }
        } catch (error) {
          console.error(error);
          alert('Failed to connect to server.');
        }
      });
    });
  </script>
</body>
</html>
